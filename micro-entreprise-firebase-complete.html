<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comptabilit√© Micro-Entreprise - Cloud Sync</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Karla:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary: #e8b298;
            --primary-light: #f0c5af;
            --primary-dark: #d99d81;
            --accent: #7c9299;
            --accent-light: #a4b8be;
            --bg: #fdfbf9;
            --card: #ffffff;
            --text: #2a2a2a;
            --text-light: #6b6b6b;
            --border: #f0ebe6;
            --success: #7c9299;
            --warning: #e8b298;
            --shadow: 0 2px 8px rgba(232, 178, 152, 0.12);
            --shadow-lg: 0 8px 24px rgba(232, 178, 152, 0.18);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Karla', sans-serif;
            background: linear-gradient(135deg, #fdfbf9 0%, #f8f4f0 100%);
            color: var(--text);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            animation: fadeInDown 0.6s ease-out;
        }

        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.8rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
            letter-spacing: -0.5px;
        }

        .subtitle {
            color: var(--text-light);
            font-size: 1.1rem;
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border);
            animation: fadeIn 0.6s ease-out 0.2s backwards;
        }

        .tab {
            padding: 1rem 2rem;
            background: none;
            border: none;
            font-family: 'Karla', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-light);
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }

        .tab:hover {
            color: var(--primary);
        }

        .tab.active {
            color: var(--primary);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
            animation: slideIn 0.3s ease-out;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            border: 1px solid var(--border);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .card-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            color: var(--primary);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .calendar-nav {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            padding: 0.7rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-family: 'Karla', sans-serif;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--accent);
            color: white;
        }

        .btn-secondary:hover {
            background: var(--accent-light);
            color: var(--text);
            transform: translateY(-2px);
        }

        .btn-outline {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        .btn-small {
            padding: 0.4rem 0.8rem;
            font-size: 0.9rem;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .calendar-day-header {
            background: var(--primary);
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: 600;
        }

        .calendar-day {
            background: white;
            min-height: 120px;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .calendar-day:hover {
            background: var(--bg);
        }

        .calendar-day.other-month {
            background: #f9f9f9;
            color: #ccc;
        }

        .calendar-day.today {
            background: var(--accent-light);
        }

        .day-number {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .day-events {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .event-item {
            padding: 0.3rem 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
            color: white;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s ease-out;
        }

        .modal-header {
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text);
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: 'Karla', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(44, 95, 79, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        .service-type-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border-left: 4px solid;
        }

        .service-type-name {
            font-weight: 600;
        }

        .service-type-price {
            color: var(--primary);
            font-weight: 600;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
        }

        .stat-card.accent {
            background: linear-gradient(135deg, var(--accent) 0%, #c89660 100%);
        }

        .stat-card.success {
            background: linear-gradient(135deg, var(--success) 0%, #388e3c 100%);
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            font-family: 'Playfair Display', serif;
        }

        .chart-container {
            margin-top: 2rem;
        }

        .month-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .month-btn {
            padding: 0.5rem 1rem;
            background: white;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .month-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .month-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .revenue-breakdown {
            display: grid;
            gap: 1rem;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 1rem;
            background: var(--bg);
            border-radius: 8px;
            align-items: center;
        }

        .breakdown-label {
            font-weight: 600;
        }

        .breakdown-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
        }

        .breakdown-value.negative {
            color: var(--warning);
        }

        .breakdown-value.positive {
            color: var(--success);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                transform: scaleX(0);
            }
            to {
                transform: scaleX(1);
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .delete-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            background: #d32f2f;
        }

        .year-selector {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .year-display {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            font-family: 'Playfair Display', serif;
        }

        .quarter-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 2px solid var(--border);
            transition: all 0.3s ease;
        }

        .quarter-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-lg);
        }

        .quarter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .quarter-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            color: var(--primary);
        }

        .quarter-period {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .quarter-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .quarter-stat {
            background: var(--bg);
            padding: 1rem;
            border-radius: 8px;
        }

        .quarter-stat-label {
            color: var(--text-light);
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }

        .quarter-stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            font-family: 'Playfair Display', serif;
        }

        .quarter-stat-value.urssaf {
            color: var(--accent);
        }

        .declaration-info {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .declaration-info strong {
            font-size: 1.1rem;
        }

        .prestations-list {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .prestations-summary {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .chart-wrapper {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            margin-top: 2rem;
            box-shadow: var(--shadow);
        }

        .chart-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .chart-canvas-container {
            position: relative;
            height: 400px;
            margin-bottom: 1rem;
        }

        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .legend-text {
            font-weight: 600;
            color: var(--text);
        }

        .legend-value {
            color: var(--text-light);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Comptabilit√© Micro-Entreprise</h1>
            <p class="subtitle">‚òÅÔ∏è Synchronisation automatique sur tous vos appareils</p>
            <div id="syncIndicator" style="margin-top: 1rem; display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--success); color: white; border-radius: 20px; font-size: 0.9rem; font-weight: 600;">
                <span id="syncIcon">‚úì</span>
                <span id="syncText">Synchronis√©</span>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem; align-items: center; flex-wrap: wrap;">
                <button class="btn btn-secondary" id="exportDataBtn">üì• Exporter mes donn√©es</button>
                <button class="btn btn-outline" id="importDataBtn">üì§ Importer mes donn√©es</button>
                <input type="file" id="importFileInput" accept=".json" style="display: none;">
                <div id="syncStatus" style="padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.9rem; display: none;"></div>
            </div>
            <div id="backupReminder" style="margin-top: 1rem; padding: 1rem; background: #fff3cd; border-radius: 8px; display: none;">
                <p style="margin: 0; color: #856404;">
                    ‚ö†Ô∏è <strong>Rappel :</strong> Pensez √† exporter vos donn√©es r√©guli√®rement pour les sauvegarder dans iCloud Drive, Dropbox ou Google Drive !
                    <button class="btn btn-small" id="dismissReminder" style="margin-left: 1rem; padding: 0.3rem 0.8rem;">J'ai compris</button>
                </p>
            </div>
        </header>

        <div class="tabs">
            <button class="tab active" data-tab="calendar">Calendrier</button>
            <button class="tab" data-tab="dashboard">Bilan Financier</button>
            <button class="tab" data-tab="evolution">√âvolution CA</button>
            <button class="tab" data-tab="urssaf">D√©claration URSSAF</button>
            <button class="tab" data-tab="charges">Charges</button>
            <button class="tab" data-tab="services">Types de Prestations</button>
        </div>

        <!-- CALENDRIER -->
        <div class="tab-content active" id="calendar">
            <div class="card">
                <div class="calendar-header">
                    <div class="calendar-nav">
                        <button class="btn btn-outline btn-small" id="prevMonth">‚Üê Mois pr√©c√©dent</button>
                        <div class="year-selector">
                            <button class="btn btn-outline btn-small" id="prevYear">‚Üê</button>
                            <span class="year-display" id="yearDisplay"></span>
                            <button class="btn btn-outline btn-small" id="nextYear">‚Üí</button>
                        </div>
                        <button class="btn btn-outline btn-small" id="nextMonth">Mois suivant ‚Üí</button>
                    </div>
                    <h2 id="currentMonth" style="font-family: 'Playfair Display', serif; font-size: 2rem; color: var(--primary);"></h2>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>
        </div>

        <!-- BILAN FINANCIER -->
        <div class="tab-content" id="dashboard">
            <div class="year-selector" style="margin-bottom: 2rem;">
                <button class="btn btn-outline btn-small" id="dashboardPrevYear">‚Üê Ann√©e pr√©c√©dente</button>
                <span class="year-display" id="dashboardYearDisplay"></span>
                <button class="btn btn-outline btn-small" id="dashboardNextYear">Ann√©e suivante ‚Üí</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Chiffre d'Affaires Annuel</div>
                    <div class="stat-value" id="totalRevenue">0 ‚Ç¨</div>
                </div>
                <div class="stat-card accent">
                    <div class="stat-label">Cotisations URSSAF (25,6%)</div>
                    <div class="stat-value" id="totalUrssaf">0 ‚Ç¨</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);">
                    <div class="stat-label">Autres Charges</div>
                    <div class="stat-value" id="totalCharges">0 ‚Ç¨</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-label">Revenu Net</div>
                    <div class="stat-value" id="netIncome">0 ‚Ç¨</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">D√©tail Mensuel</h3>
                </div>
                <div class="month-selector" id="monthSelector"></div>
                <div class="revenue-breakdown" id="revenueBreakdown"></div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">R√©partition par Type de Prestation</h3>
                </div>
                <div class="revenue-breakdown" id="serviceBreakdown"></div>
                
                <div class="chart-wrapper">
                    <h4 class="chart-title">R√©partition du Chiffre d'Affaires</h4>
                    <div class="chart-canvas-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                    <div class="chart-legend" id="chartLegend"></div>
                </div>
            </div>
        </div>

        <!-- √âVOLUTION CA -->
        <div class="tab-content" id="evolution">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">√âvolution du Chiffre d'Affaires Annuel</h3>
                    <button class="btn btn-primary" id="addHistoricalYearBtn">+ Ajouter une ann√©e</button>
                </div>
                
                <div style="background: var(--accent-light); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                    <p style="margin-bottom: 0.5rem;"><strong>üìä Suivez votre croissance :</strong></p>
                    <p style="color: var(--text); margin: 0;">Ce graphique affiche l'√©volution de votre CA ann√©e apr√®s ann√©e. Les ann√©es avec prestations enregistr√©es s'affichent automatiquement. Vous pouvez ajouter manuellement les ann√©es pr√©c√©dentes pour compl√©ter l'historique.</p>
                </div>

                <div class="chart-wrapper">
                    <div class="chart-canvas-container" style="height: 450px;">
                        <canvas id="evolutionChart"></canvas>
                    </div>
                </div>

                <div class="card" style="margin-top: 2rem;">
                    <div class="card-header">
                        <h3 class="card-title">Historique Ann√©es Pr√©c√©dentes</h3>
                    </div>
                    <div id="historicalYearsList"></div>
                </div>
            </div>
        </div>

        <!-- D√âCLARATION URSSAF -->
        <div class="tab-content" id="urssaf">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Aide √† la D√©claration URSSAF Trimestrielle</h3>
                </div>
                
                <div style="background: var(--accent-light); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                    <p style="margin-bottom: 0.5rem;"><strong>üìã Rappel :</strong></p>
                    <p style="color: var(--text); margin: 0;">En micro-entreprise, vous devez d√©clarer votre chiffre d'affaires <strong>chaque trimestre</strong> sur autoentrepreneur.urssaf.fr. Les cotisations sociales (25,6% du CA) sont calcul√©es et pr√©lev√©es automatiquement par l'URSSAF.</p>
                </div>

                <div class="year-selector" style="margin-bottom: 2rem;">
                    <button class="btn btn-outline btn-small" id="urssafPrevYear">‚Üê Ann√©e pr√©c√©dente</button>
                    <span class="year-display" id="urssafYearDisplay"></span>
                    <button class="btn btn-outline btn-small" id="urssafNextYear">Ann√©e suivante ‚Üí</button>
                </div>

                <div id="urssafQuarters"></div>
            </div>
        </div>

        <!-- CHARGES -->
        <div class="tab-content" id="charges">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">G√©rer les Charges</h3>
                    <button class="btn btn-primary" id="addChargeBtn">+ Nouvelle Charge</button>
                </div>
                
                <div style="margin-bottom: 2rem;">
                    <p style="color: var(--text-light); font-size: 0.95rem;">
                        <strong>Note :</strong> Les cotisations URSSAF (25,6% du CA) sont automatiquement calcul√©es dans le bilan. 
                        Ajoutez ici vos autres charges professionnelles (loyer, t√©l√©phone, assurances, comptable, etc.)
                    </p>
                </div>

                <div class="year-selector" style="margin-bottom: 1.5rem;">
                    <button class="btn btn-outline btn-small" id="chargesPrevYear">‚Üê Ann√©e pr√©c√©dente</button>
                    <span class="year-display" id="chargesYearDisplay"></span>
                    <button class="btn btn-outline btn-small" id="chargesNextYear">Ann√©e suivante ‚Üí</button>
                </div>

                <div id="chargesList"></div>
            </div>
        </div>

        <!-- TYPES DE PRESTATIONS -->
        <div class="tab-content" id="services">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">G√©rer les Types de Prestations</h3>
                    <button class="btn btn-primary" id="addServiceBtn">+ Nouvelle Prestation</button>
                </div>
                <div id="serviceTypesList"></div>
            </div>
        </div>
    </div>

    <!-- Modal Ajout/√âdition Prestation -->
    <div class="modal" id="eventModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Ajouter une prestation</h3>
            </div>
            <form id="eventForm">
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-input" id="eventDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Type de prestation</label>
                    <select class="form-select" id="eventType" required>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Nombre de jours/heures</label>
                    <input type="number" class="form-input" id="eventDuration" step="0.5" value="1" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Prix total (‚Ç¨)</label>
                    <input type="number" class="form-input" id="eventPrice" step="0.01" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Note (optionnel)</label>
                    <input type="text" class="form-input" id="eventNote">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" id="cancelEvent">Annuler</button>
                    <button type="button" class="btn delete-btn" id="deleteEvent" style="display: none;">Supprimer</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Type de Service -->
    <div class="modal" id="serviceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nouveau Type de Prestation</h3>
            </div>
            <form id="serviceForm">
                <div class="form-group">
                    <label class="form-label">Nom de la prestation</label>
                    <input type="text" class="form-input" id="serviceName" placeholder="Ex: Formation demi-journ√©e" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Tarif de base (‚Ç¨)</label>
                    <input type="number" class="form-input" id="servicePrice" step="0.01" placeholder="Ex: 500" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Couleur</label>
                    <input type="color" class="form-input" id="serviceColor" value="#e8b298">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" id="cancelService">Annuler</button>
                    <button type="submit" class="btn btn-primary">Cr√©er</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Charge -->
    <div class="modal" id="chargeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="chargeModalTitle">Nouvelle Charge</h3>
            </div>
            <form id="chargeForm">
                <div class="form-group">
                    <label class="form-label">Nom de la charge</label>
                    <input type="text" class="form-input" id="chargeName" placeholder="Ex: Loyer bureau" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Montant (‚Ç¨)</label>
                    <input type="number" class="form-input" id="chargeAmount" step="0.01" placeholder="Ex: 500" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Fr√©quence</label>
                    <select class="form-select" id="chargeFrequency" required>
                        <option value="monthly">Mensuelle</option>
                        <option value="annual">Annuelle</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Ann√©e</label>
                    <input type="number" class="form-input" id="chargeYear" required>
                </div>
                <div class="form-group" id="chargeMonthGroup" style="display: none;">
                    <label class="form-label">Mois</label>
                    <select class="form-select" id="chargeMonth">
                        <option value="0">Janvier</option>
                        <option value="1">F√©vrier</option>
                        <option value="2">Mars</option>
                        <option value="3">Avril</option>
                        <option value="4">Mai</option>
                        <option value="5">Juin</option>
                        <option value="6">Juillet</option>
                        <option value="7">Ao√ªt</option>
                        <option value="8">Septembre</option>
                        <option value="9">Octobre</option>
                        <option value="10">Novembre</option>
                        <option value="11">D√©cembre</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" id="cancelCharge">Annuler</button>
                    <button type="button" class="btn delete-btn" id="deleteCharge" style="display: none;">Supprimer</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Historical Year -->
    <div class="modal" id="historicalYearModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="historicalYearModalTitle">Ajouter une ann√©e pr√©c√©dente</h3>
            </div>
            <form id="historicalYearForm">
                <div class="form-group">
                    <label class="form-label">Ann√©e</label>
                    <input type="number" class="form-input" id="historicalYear" placeholder="Ex: 2023" required min="2000" max="2100">
                </div>
                <div class="form-group">
                    <label class="form-label">Chiffre d'Affaires (‚Ç¨)</label>
                    <input type="number" class="form-input" id="historicalCA" step="0.01" placeholder="Ex: 45000" required min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Note (optionnel)</label>
                    <input type="text" class="form-input" id="historicalNote" placeholder="Ex: Premi√®re ann√©e d'activit√©">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" id="cancelHistoricalYear">Annuler</button>
                    <button type="button" class="btn delete-btn" id="deleteHistoricalYear" style="display: none;">Supprimer</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ========================================
        // FIREBASE CONFIGURATION
        // ========================================
        // IMPORTANT: Remplacez ces valeurs par vos identifiants Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAMRcW1CCFgZZ4H8jv2EsLsPuzVhpX7Wp8",
			authDomain: "compta-microentreprise.firebaseapp.com",
			projectId: "compta-microentreprise",
			storageBucket: "compta-microentreprise.firebasestorage.app",
			messagingSenderId: "1079427218173",
			appId: "1:1079427218173:web:dbdb8d145a7ee12e309c94",
			measurementId: "G-386TQE9W7B"
        };

        // Initialize Firebase
        let firebaseApp, auth, database, currentUser = null, userDataRef = null;
        let firebaseEnabled = false;

        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            database = firebase.database();
            firebaseEnabled = true;
            console.log('‚úÖ Firebase initialis√©');
            
            // Connexion anonyme automatique
            auth.signInAnonymously().then(() => {
                console.log('‚úÖ Connexion anonyme r√©ussie');
            }).catch(error => {
                console.error('‚ùå Erreur connexion anonyme:', error);
                updateSyncStatus('offline', 'Hors ligne');
            });
            
        } catch (error) {
            console.warn('‚ö†Ô∏è  Firebase non configur√© - mode local uniquement');
            console.warn('Pour activer la synchronisation cloud, configurez Firebase dans le code.');
            firebaseEnabled = false;
            updateSyncStatus('offline', 'Mode local');
        }

        // Auth state listener
        if (firebaseEnabled) {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    userDataRef = database.ref('users/' + user.uid);
                    updateSyncStatus('syncing', 'Chargement...');
                    loadFromFirebase();
                    console.log('‚úÖ Utilisateur connect√©:', user.uid);
                } else {
                    updateSyncStatus('offline', 'D√©connect√©');
                }
            });
        }

        // Update sync status indicator
        function updateSyncStatus(status, text) {
            const indicator = document.getElementById('syncIndicator');
            const icon = document.getElementById('syncIcon');
            const textEl = document.getElementById('syncText');
            
            if (!indicator) return;
            
            if (status === 'syncing') {
                indicator.style.background = 'var(--warning)';
                icon.textContent = '‚ü≥';
                icon.style.animation = 'spin 1s linear infinite';
            } else if (status === 'online') {
                indicator.style.background = 'var(--success)';
                icon.textContent = '‚úì';
                icon.style.animation = 'none';
            } else {
                indicator.style.background = '#999';
                icon.textContent = '‚ö†';
                icon.style.animation = 'none';
            }
            
            textEl.textContent = text;
        }

        // Load data from Firebase
        function loadFromFirebase() {
            if (!userDataRef) {
                updateSyncStatus('offline', 'Mode local');
                return;
            }
            
            userDataRef.once('value').then(snapshot => {
                const data = snapshot.val();
                if (data) {
                    console.log('üì• Donn√©es charg√©es depuis Firebase');
                    
                    serviceTypes = data.serviceTypes || serviceTypes;
                    events = data.events || events;
                    charges = data.charges || charges;
                    historicalYears = data.historicalYears || historicalYears;
                    
                    // Save to localStorage as backup
                    localStorage.setItem('serviceTypes', JSON.stringify(serviceTypes));
                    localStorage.setItem('events', JSON.stringify(events));
                    localStorage.setItem('charges', JSON.stringify(charges));
                    localStorage.setItem('historicalYears', JSON.stringify(historicalYears));
                    
                    // Refresh UI
                    renderCalendar();
                    if (document.querySelector('.tab.active[data-tab="dashboard"]')) {
                        updateDashboard();
                    }
                }
                updateSyncStatus('online', 'Synchronis√©');
            }).catch(error => {
                console.error('‚ùå Erreur chargement Firebase:', error);
                updateSyncStatus('offline', 'Erreur sync');
            });
            
            // Listen for real-time updates
            userDataRef.on('value', snapshot => {
                const data = snapshot.val();
                if (data && data.lastUpdate) {
                    const cloudTime = new Date(data.lastUpdate).getTime();
                    const localTime = localStorage.getItem('lastLocalUpdate');
                    
                    // Only update if cloud data is newer
                    if (!localTime || cloudTime > parseInt(localTime)) {
                        console.log('üîÑ Mise √† jour automatique depuis le cloud');
                        
                        serviceTypes = data.serviceTypes || serviceTypes;
                        events = data.events || events;
                        charges = data.charges || charges;
                        historicalYears = data.historicalYears || historicalYears;
                        
                        renderCalendar();
                        updateSyncStatus('online', 'Synchronis√©');
                    }
                }
            });
        }

        // ========================================
        // APPLICATION STATE
        // ========================================
        
        // √âtat de l'application
        let currentDate = new Date();
        let currentYear = currentDate.getFullYear();
        let currentMonth = currentDate.getMonth();
        let dashboardYear = currentYear;
        let selectedDate = null;
        let editingEventId = null;

        // Donn√©es
        let serviceTypes = JSON.parse(localStorage.getItem('serviceTypes')) || [
            { id: 1, name: 'Formation journ√©e', price: 800, color: '#e8b298' },
            { id: 2, name: 'Formation demi-journ√©e', price: 400, color: '#f0c5af' },
            { id: 3, name: 'Consulting', price: 600, color: '#7c9299' }
        ];

        let events = JSON.parse(localStorage.getItem('events')) || [];
        let charges = JSON.parse(localStorage.getItem('charges')) || [];
        let editingChargeId = null;
        let chargesYear = currentYear;
        let urssafYear = currentYear;
        let revenueChart = null;
        let historicalYears = JSON.parse(localStorage.getItem('historicalYears')) || [];
        let editingHistoricalYearId = null;
        let evolutionChart = null;

        // Sauvegarde
        function saveData() {
            // Local storage (backup)
            localStorage.setItem('serviceTypes', JSON.stringify(serviceTypes));
            localStorage.setItem('events', JSON.stringify(events));
            localStorage.setItem('charges', JSON.stringify(charges));
            localStorage.setItem('historicalYears', JSON.stringify(historicalYears));
            localStorage.setItem('lastLocalUpdate', Date.now().toString());
            
            // Firebase sync
            if (firebaseEnabled && userDataRef) {
                updateSyncStatus('syncing', 'Synchronisation...');
                
                userDataRef.set({
                    serviceTypes: serviceTypes,
                    events: events,
                    charges: charges,
                    historicalYears: historicalYears,
                    lastUpdate: new Date().toISOString()
                }).then(() => {
                    console.log('‚òÅÔ∏è  Sauvegarde Firebase r√©ussie');
                    updateSyncStatus('online', 'Synchronis√©');
                }).catch(error => {
                    console.error('‚ùå Erreur sauvegarde Firebase:', error);
                    updateSyncStatus('offline', 'Erreur sync');
                });
            }
        }

        // Onglets
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(tabName).classList.add('active');
                
                if (tabName === 'dashboard') {
                    updateDashboard();
                } else if (tabName === 'services') {
                    renderServiceTypes();
                } else if (tabName === 'charges') {
                    renderCharges();
                } else if (tabName === 'urssaf') {
                    renderUrssafDeclaration();
                } else if (tabName === 'evolution') {
                    renderEvolution();
                }
            });
        });

        // Calendrier
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
            const dayNames = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
            
            document.getElementById('currentMonth').textContent = `${monthNames[currentMonth]} ${currentYear}`;
            document.getElementById('yearDisplay').textContent = currentYear;
            
            grid.innerHTML = '';
            
            // Headers
            dayNames.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                grid.appendChild(header);
            });
            
            // Get first day of month (0 = Sunday, need to adjust to Monday = 0)
            const firstDay = new Date(currentYear, currentMonth, 1);
            let startDay = firstDay.getDay() - 1;
            if (startDay === -1) startDay = 6; // Sunday becomes 6
            
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const daysInPrevMonth = new Date(currentYear, currentMonth, 0).getDate();
            
            // Previous month days
            for (let i = startDay - 1; i >= 0; i--) {
                const day = document.createElement('div');
                day.className = 'calendar-day other-month';
                day.innerHTML = `<div class="day-number">${daysInPrevMonth - i}</div>`;
                grid.appendChild(day);
            }
            
            // Current month days
            const today = new Date();
            for (let i = 1; i <= daysInMonth; i++) {
                const day = document.createElement('div');
                day.className = 'calendar-day';
                
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                
                if (today.getDate() === i && today.getMonth() === currentMonth && today.getFullYear() === currentYear) {
                    day.classList.add('today');
                }
                
                day.innerHTML = `<div class="day-number">${i}</div><div class="day-events" id="events-${dateStr}"></div>`;
                
                day.addEventListener('click', () => {
                    selectedDate = dateStr;
                    openEventModal();
                });
                
                grid.appendChild(day);
                
                // Render events for this day
                renderDayEvents(dateStr);
            }
            
            // Next month days
            const totalCells = grid.children.length - 7; // Minus headers
            const remainingCells = 42 - totalCells - 7; // 6 weeks * 7 days - already filled - headers
            for (let i = 1; i <= remainingCells; i++) {
                const day = document.createElement('div');
                day.className = 'calendar-day other-month';
                day.innerHTML = `<div class="day-number">${i}</div>`;
                grid.appendChild(day);
            }
        }

        function renderDayEvents(dateStr) {
            const container = document.getElementById(`events-${dateStr}`);
            if (!container) return;
            
            container.innerHTML = '';
            const dayEvents = events.filter(e => e.date === dateStr);
            
            dayEvents.forEach(event => {
                const serviceType = serviceTypes.find(s => s.id === event.serviceTypeId);
                if (!serviceType) return;
                
                const eventEl = document.createElement('div');
                eventEl.className = 'event-item';
                eventEl.style.backgroundColor = serviceType.color;
                eventEl.textContent = serviceType.name;
                eventEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    editEvent(event.id);
                });
                container.appendChild(eventEl);
            });
        }

        // Navigation calendrier
        document.getElementById('prevMonth').addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
        });

        document.getElementById('prevYear').addEventListener('click', () => {
            currentYear--;
            renderCalendar();
        });

        document.getElementById('nextYear').addEventListener('click', () => {
            currentYear++;
            renderCalendar();
        });

        // Modal √©v√©nement
        function openEventModal(event = null) {
            const modal = document.getElementById('eventModal');
            const form = document.getElementById('eventForm');
            
            if (event) {
                editingEventId = event.id;
                document.getElementById('modalTitle').textContent = 'Modifier la prestation';
                document.getElementById('eventDate').value = event.date;
                document.getElementById('eventType').value = event.serviceTypeId;
                document.getElementById('eventDuration').value = event.duration;
                document.getElementById('eventPrice').value = event.price;
                document.getElementById('eventNote').value = event.note || '';
                document.getElementById('deleteEvent').style.display = 'block';
            } else {
                editingEventId = null;
                document.getElementById('modalTitle').textContent = 'Ajouter une prestation';
                form.reset();
                document.getElementById('eventDate').value = selectedDate;
                document.getElementById('deleteEvent').style.display = 'none';
                
                // Set default price
                const firstService = serviceTypes[0];
                if (firstService) {
                    document.getElementById('eventType').value = firstService.id;
                    document.getElementById('eventPrice').value = firstService.price;
                }
            }
            
            updateServiceTypeOptions();
            modal.classList.add('active');
        }

        function updateServiceTypeOptions() {
            const select = document.getElementById('eventType');
            select.innerHTML = '';
            
            serviceTypes.forEach(service => {
                const option = document.createElement('option');
                option.value = service.id;
                option.textContent = `${service.name} (${service.price}‚Ç¨)`;
                select.appendChild(option);
            });
        }

        // Update price when service type changes
        document.getElementById('eventType').addEventListener('change', (e) => {
            const serviceType = serviceTypes.find(s => s.id == e.target.value);
            if (serviceType) {
                const duration = parseFloat(document.getElementById('eventDuration').value) || 1;
                document.getElementById('eventPrice').value = serviceType.price * duration;
            }
        });

        // Update price when duration changes
        document.getElementById('eventDuration').addEventListener('input', (e) => {
            const serviceTypeId = parseInt(document.getElementById('eventType').value);
            const serviceType = serviceTypes.find(s => s.id === serviceTypeId);
            if (serviceType) {
                const duration = parseFloat(e.target.value) || 1;
                document.getElementById('eventPrice').value = serviceType.price * duration;
            }
        });

        document.getElementById('eventForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            console.log('Form submitted');
            
            const dateValue = document.getElementById('eventDate').value;
            const typeValue = document.getElementById('eventType').value;
            const durationValue = document.getElementById('eventDuration').value;
            const priceValue = document.getElementById('eventPrice').value;
            
            console.log('Form values:', { dateValue, typeValue, durationValue, priceValue });
            
            if (!dateValue || !typeValue || !durationValue || !priceValue) {
                alert('Veuillez remplir tous les champs obligatoires');
                return;
            }
            
            const eventData = {
                id: editingEventId || Date.now(),
                date: dateValue,
                serviceTypeId: parseInt(typeValue),
                duration: parseFloat(durationValue),
                price: parseFloat(priceValue),
                note: document.getElementById('eventNote').value
            };
            
            console.log('Event data:', eventData);
            
            if (editingEventId) {
                const index = events.findIndex(e => e.id === editingEventId);
                events[index] = eventData;
            } else {
                events.push(eventData);
            }
            
            console.log('Events after save:', events);
            
            saveData();
            closeEventModal();
            renderCalendar();
        });

        document.getElementById('deleteEvent').addEventListener('click', () => {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette prestation ?')) {
                events = events.filter(e => e.id !== editingEventId);
                saveData();
                closeEventModal();
                renderCalendar();
            }
        });

        document.getElementById('cancelEvent').addEventListener('click', closeEventModal);

        function closeEventModal() {
            document.getElementById('eventModal').classList.remove('active');
            editingEventId = null;
        }

        function editEvent(eventId) {
            const event = events.find(e => e.id === eventId);
            if (event) {
                openEventModal(event);
            }
        }

        // Close modals on background click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // Types de services
        function renderServiceTypes() {
            const container = document.getElementById('serviceTypesList');
            container.innerHTML = '';
            
            serviceTypes.forEach(service => {
                const item = document.createElement('div');
                item.className = 'service-type-item';
                item.style.borderLeftColor = service.color;
                item.innerHTML = `
                    <div>
                        <div class="service-type-name">${service.name}</div>
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <div class="service-type-price">${service.price}‚Ç¨</div>
                        <button class="delete-btn" onclick="deleteServiceType(${service.id})">Supprimer</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        document.getElementById('addServiceBtn').addEventListener('click', () => {
            document.getElementById('serviceModal').classList.add('active');
        });

        document.getElementById('serviceForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const newService = {
                id: Date.now(),
                name: document.getElementById('serviceName').value,
                price: parseFloat(document.getElementById('servicePrice').value),
                color: document.getElementById('serviceColor').value
            };
            
            serviceTypes.push(newService);
            saveData();
            document.getElementById('serviceModal').classList.remove('active');
            document.getElementById('serviceForm').reset();
            renderServiceTypes();
        });

        document.getElementById('cancelService').addEventListener('click', () => {
            document.getElementById('serviceModal').classList.remove('active');
        });

        function deleteServiceType(id) {
            if (confirm('√ätes-vous s√ªr ? Les prestations existantes ne seront pas supprim√©es.')) {
                serviceTypes = serviceTypes.filter(s => s.id !== id);
                saveData();
                renderServiceTypes();
            }
        }

        // Charges Management
        function renderCharges() {
            document.getElementById('chargesYearDisplay').textContent = chargesYear;
            const container = document.getElementById('chargesList');
            container.innerHTML = '';
            
            const yearCharges = charges.filter(c => c.year === chargesYear);
            
            if (yearCharges.length === 0) {
                container.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 2rem;">Aucune charge enregistr√©e pour cette ann√©e</p>';
                return;
            }
            
            // Group by frequency
            const monthlyCharges = yearCharges.filter(c => c.frequency === 'monthly');
            const annualCharges = yearCharges.filter(c => c.frequency === 'annual');
            
            if (annualCharges.length > 0) {
                const section = document.createElement('div');
                section.innerHTML = '<h4 style="color: var(--primary); margin-bottom: 1rem; font-family: \'Playfair Display\', serif;">Charges annuelles</h4>';
                container.appendChild(section);
                
                annualCharges.forEach(charge => {
                    const item = createChargeItem(charge);
                    container.appendChild(item);
                });
            }
            
            if (monthlyCharges.length > 0) {
                const section = document.createElement('div');
                section.innerHTML = '<h4 style="color: var(--primary); margin: 2rem 0 1rem 0; font-family: \'Playfair Display\', serif;">Charges mensuelles</h4>';
                container.appendChild(section);
                
                // Group by month
                const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
                
                for (let m = 0; m < 12; m++) {
                    const monthCharges = monthlyCharges.filter(c => c.month === m);
                    if (monthCharges.length > 0) {
                        const monthHeader = document.createElement('h5');
                        monthHeader.style.cssText = 'color: var(--text); margin: 1.5rem 0 0.5rem 0; font-weight: 600;';
                        monthHeader.textContent = monthNames[m];
                        container.appendChild(monthHeader);
                        
                        monthCharges.forEach(charge => {
                            const item = createChargeItem(charge);
                            container.appendChild(item);
                        });
                    }
                }
            }
            
            // Calculate total
            const totalAnnual = annualCharges.reduce((sum, c) => sum + c.amount, 0);
            const totalMonthly = monthlyCharges.reduce((sum, c) => sum + c.amount, 0);
            const total = totalAnnual + totalMonthly;
            
            const totalSection = document.createElement('div');
            totalSection.className = 'breakdown-item';
            totalSection.style.cssText = 'margin-top: 2rem; background: var(--primary); color: white;';
            totalSection.innerHTML = `
                <div>
                    <div style="font-weight: 600; font-size: 1.1rem;">Total des charges ${chargesYear}</div>
                    <div style="opacity: 0.9; font-size: 0.9rem;">(hors URSSAF)</div>
                </div>
                <span style="font-size: 1.5rem; font-weight: 700;">${total.toFixed(2)} ‚Ç¨</span>
            `;
            container.appendChild(totalSection);
        }

        function createChargeItem(charge) {
            const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
            const item = document.createElement('div');
            item.className = 'service-type-item';
            item.style.borderLeftColor = charge.frequency === 'annual' ? '#7c9299' : '#e8b298';
            
            const frequencyText = charge.frequency === 'annual' ? 'Annuelle' : monthNames[charge.month];
            
            item.innerHTML = `
                <div>
                    <div class="service-type-name">${charge.name}</div>
                    <div style="color: var(--text-light); font-size: 0.9rem;">${frequencyText}</div>
                </div>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <div class="service-type-price">${charge.amount.toFixed(2)} ‚Ç¨</div>
                    <button class="btn btn-outline btn-small" onclick="editCharge(${charge.id})">Modifier</button>
                    <button class="delete-btn" onclick="deleteCharge(${charge.id})">Supprimer</button>
                </div>
            `;
            return item;
        }

        document.getElementById('chargesPrevYear').addEventListener('click', () => {
            chargesYear--;
            renderCharges();
        });

        document.getElementById('chargesNextYear').addEventListener('click', () => {
            chargesYear++;
            renderCharges();
        });

        document.getElementById('addChargeBtn').addEventListener('click', () => {
            editingChargeId = null;
            document.getElementById('chargeModalTitle').textContent = 'Nouvelle Charge';
            document.getElementById('chargeForm').reset();
            document.getElementById('chargeYear').value = chargesYear;
            document.getElementById('deleteCharge').style.display = 'none';
            document.getElementById('chargeMonth').value = new Date().getMonth();
            updateChargeFrequencyDisplay();
            document.getElementById('chargeModal').classList.add('active');
        });

        document.getElementById('chargeFrequency').addEventListener('change', updateChargeFrequencyDisplay);

        function updateChargeFrequencyDisplay() {
            const frequency = document.getElementById('chargeFrequency').value;
            const monthGroup = document.getElementById('chargeMonthGroup');
            monthGroup.style.display = frequency === 'monthly' ? 'block' : 'none';
        }

        document.getElementById('chargeForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const chargeData = {
                id: editingChargeId || Date.now(),
                name: document.getElementById('chargeName').value,
                amount: parseFloat(document.getElementById('chargeAmount').value),
                frequency: document.getElementById('chargeFrequency').value,
                year: parseInt(document.getElementById('chargeYear').value),
                month: document.getElementById('chargeFrequency').value === 'monthly' ? 
                    parseInt(document.getElementById('chargeMonth').value) : null
            };
            
            if (editingChargeId) {
                const index = charges.findIndex(c => c.id === editingChargeId);
                charges[index] = chargeData;
            } else {
                charges.push(chargeData);
            }
            
            saveData();
            document.getElementById('chargeModal').classList.remove('active');
            renderCharges();
            
            // Update dashboard if we're viewing the same year
            if (dashboardYear === chargeData.year) {
                updateDashboard();
            }
        });

        document.getElementById('cancelCharge').addEventListener('click', () => {
            document.getElementById('chargeModal').classList.remove('active');
        });

        document.getElementById('deleteCharge').addEventListener('click', () => {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette charge ?')) {
                charges = charges.filter(c => c.id !== editingChargeId);
                saveData();
                document.getElementById('chargeModal').classList.remove('active');
                renderCharges();
                updateDashboard();
            }
        });

        function editCharge(chargeId) {
            const charge = charges.find(c => c.id === chargeId);
            if (!charge) return;
            
            editingChargeId = chargeId;
            document.getElementById('chargeModalTitle').textContent = 'Modifier la Charge';
            document.getElementById('chargeName').value = charge.name;
            document.getElementById('chargeAmount').value = charge.amount;
            document.getElementById('chargeFrequency').value = charge.frequency;
            document.getElementById('chargeYear').value = charge.year;
            if (charge.month !== null) {
                document.getElementById('chargeMonth').value = charge.month;
            }
            document.getElementById('deleteCharge').style.display = 'block';
            updateChargeFrequencyDisplay();
            document.getElementById('chargeModal').classList.add('active');
        }

        function deleteCharge(chargeId) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette charge ?')) {
                charges = charges.filter(c => c.id !== chargeId);
                saveData();
                renderCharges();
                updateDashboard();
            }
        }

        // Export/Import Data
        function showSyncStatus(message, type = 'info') {
            const status = document.getElementById('syncStatus');
            status.style.display = 'block';
            status.textContent = message;
            
            if (type === 'success') {
                status.style.background = '#d4edda';
                status.style.color = '#155724';
            } else if (type === 'warning') {
                status.style.background = '#fff3cd';
                status.style.color = '#856404';
            } else {
                status.style.background = '#d1ecf1';
                status.style.color = '#0c5460';
            }
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        }

        // Auto-backup reminder
        function checkBackupReminder() {
            const lastBackup = localStorage.getItem('lastBackupDate');
            const dismissedUntil = localStorage.getItem('backupReminderDismissed');
            
            if (dismissedUntil && new Date(dismissedUntil) > new Date()) {
                return; // Reminder dismissed
            }
            
            if (!lastBackup) {
                // First time user
                document.getElementById('backupReminder').style.display = 'block';
                return;
            }
            
            const daysSinceBackup = (Date.now() - new Date(lastBackup).getTime()) / (1000 * 60 * 60 * 24);
            
            if (daysSinceBackup > 7) {
                // Show reminder if more than 7 days since last backup
                document.getElementById('backupReminder').style.display = 'block';
            }
        }

        document.getElementById('dismissReminder').addEventListener('click', () => {
            const dismissUntil = new Date();
            dismissUntil.setDate(dismissUntil.getDate() + 7); // Dismiss for 7 days
            localStorage.setItem('backupReminderDismissed', dismissUntil.toISOString());
            document.getElementById('backupReminder').style.display = 'none';
        });

        document.getElementById('exportDataBtn').addEventListener('click', () => {
            const dataToExport = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                serviceTypes: serviceTypes,
                events: events,
                charges: charges,
                historicalYears: historicalYears
            };
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            
            const today = new Date().toISOString().split('T')[0];
            link.download = `comptabilite-microentreprise-${today}.json`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Update last backup date
            localStorage.setItem('lastBackupDate', new Date().toISOString());
            
            // Show confirmation
            showSyncStatus('‚úÖ Donn√©es export√©es ! Sauvegardez ce fichier dans iCloud Drive.', 'success');
            
            setTimeout(() => {
                alert('üí° ASTUCE : Sauvegardez ce fichier dans :\n\n' +
                      '‚Ä¢ iCloud Drive (pour Mac/iPhone/iPad)\n' +
                      '‚Ä¢ Google Drive\n' +
                      '‚Ä¢ Dropbox\n\n' +
                      'Vous pourrez l\'importer sur tous vos appareils !');
            }, 500);
        });

        document.getElementById('importDataBtn').addEventListener('click', () => {
            document.getElementById('importFileInput').click();
        });

        document.getElementById('importFileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    
                    // Validation basique
                    if (!importedData.version || !importedData.serviceTypes || !importedData.events) {
                        throw new Error('Format de fichier invalide');
                    }
                    
                    // Confirmation avant import
                    const confirmMessage = `‚ö†Ô∏è ATTENTION ‚ö†Ô∏è\n\n` +
                        `Vous √™tes sur le point d'importer des donn√©es :\n` +
                        `- ${importedData.serviceTypes.length} types de prestations\n` +
                        `- ${importedData.events.length} prestations\n` +
                        `- ${(importedData.charges || []).length} charges\n` +
                        `- ${(importedData.historicalYears || []).length} ann√©es historiques\n\n` +
                        `Export du : ${new Date(importedData.exportDate).toLocaleString('fr-FR')}\n\n` +
                        `Cela REMPLACERA toutes vos donn√©es actuelles.\n\n` +
                        `Voulez-vous continuer ?`;
                    
                    if (!confirm(confirmMessage)) {
                        e.target.value = ''; // Reset file input
                        return;
                    }
                    
                    // Import des donn√©es
                    serviceTypes = importedData.serviceTypes;
                    events = importedData.events;
                    charges = importedData.charges || [];
                    historicalYears = importedData.historicalYears || [];
                    
                    // Sauvegarde dans localStorage
                    saveData();
                    
                    // Rafra√Æchir l'affichage
                    renderCalendar();
                    updateDashboard();
                    renderServiceTypes();
                    renderCharges();
                    
                    alert('‚úÖ Import r√©ussi !\n\nToutes vos donn√©es ont √©t√© restaur√©es avec succ√®s.');
                    
                    // Reset file input
                    e.target.value = '';
                    
                } catch (error) {
                    alert('‚ùå Erreur lors de l\'import !\n\nLe fichier s√©lectionn√© n\'est pas valide ou est corrompu.\n\nErreur: ' + error.message);
                    e.target.value = ''; // Reset file input
                }
            };
            
            reader.readAsText(file);
        });

        // Evolution Chart and Historical Years
        function renderEvolution() {
            renderEvolutionChart();
            renderHistoricalYearsList();
        }

        function renderEvolutionChart() {
            const canvas = document.getElementById('evolutionChart');
            if (!canvas) return;
            
            // Destroy existing chart
            if (evolutionChart) {
                evolutionChart.destroy();
            }
            
            // Calculate CA by year from events
            const yearlyCA = {};
            
            events.forEach(event => {
                const year = new Date(event.date).getFullYear();
                if (!yearlyCA[year]) {
                    yearlyCA[year] = 0;
                }
                yearlyCA[year] += event.price;
            });
            
            // Add historical years
            historicalYears.forEach(hy => {
                if (!yearlyCA[hy.year]) {
                    yearlyCA[hy.year] = 0;
                }
                yearlyCA[hy.year] += hy.ca;
            });
            
            // Sort years and prepare data
            const years = Object.keys(yearlyCA).map(y => parseInt(y)).sort((a, b) => a - b);
            const caValues = years.map(year => yearlyCA[year]);
            
            // Calculate growth rates
            const growthRates = years.map((year, index) => {
                if (index === 0) return null;
                const prevCA = yearlyCA[years[index - 1]];
                const currentCA = yearlyCA[year];
                if (prevCA === 0) return null;
                return ((currentCA - prevCA) / prevCA * 100).toFixed(1);
            });
            
            const ctx = canvas.getContext('2d');
            evolutionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Chiffre d\'Affaires (‚Ç¨)',
                        data: caValues,
                        backgroundColor: 'rgba(232, 178, 152, 0.2)',
                        borderColor: '#e8b298',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#e8b298',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverBackgroundColor: '#d99d81',
                        pointHoverBorderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14,
                                    weight: 'bold',
                                    family: "'Karla', sans-serif"
                                },
                                color: '#2a2a2a',
                                padding: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 15,
                            titleFont: {
                                size: 16,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 14
                            },
                            callbacks: {
                                title: function(context) {
                                    return `Ann√©e ${context[0].label}`;
                                },
                                label: function(context) {
                                    const year = context.label;
                                    const ca = context.parsed.y;
                                    const index = years.indexOf(parseInt(year));
                                    const growth = growthRates[index];
                                    
                                    const labels = [`CA: ${ca.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} ‚Ç¨`];
                                    
                                    if (growth !== null) {
                                        const growthText = growth >= 0 ? `+${growth}%` : `${growth}%`;
                                        const emoji = growth >= 0 ? 'üìà' : 'üìâ';
                                        labels.push(`√âvolution: ${emoji} ${growthText}`);
                                    }
                                    
                                    return labels;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('fr-FR') + ' ‚Ç¨';
                                },
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 13,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function renderHistoricalYearsList() {
            const container = document.getElementById('historicalYearsList');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (historicalYears.length === 0) {
                container.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 2rem;">Aucune ann√©e historique enregistr√©e. Cliquez sur "+ Ajouter une ann√©e" pour ajouter les CA des ann√©es pr√©c√©dentes.</p>';
                return;
            }
            
            // Sort by year descending
            const sortedYears = [...historicalYears].sort((a, b) => b.year - a.year);
            
            sortedYears.forEach(hy => {
                const item = document.createElement('div');
                item.className = 'service-type-item';
                item.style.borderLeftColor = '#7c9299';
                item.innerHTML = `
                    <div>
                        <div class="service-type-name">Ann√©e ${hy.year}</div>
                        ${hy.note ? `<div style="color: var(--text-light); font-size: 0.9rem;">${hy.note}</div>` : ''}
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <div class="service-type-price">${hy.ca.toFixed(2)} ‚Ç¨</div>
                        <button class="btn btn-outline btn-small" onclick="editHistoricalYear(${hy.id})">Modifier</button>
                        <button class="delete-btn" onclick="deleteHistoricalYear(${hy.id})">Supprimer</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        document.getElementById('addHistoricalYearBtn').addEventListener('click', () => {
            editingHistoricalYearId = null;
            document.getElementById('historicalYearModalTitle').textContent = 'Ajouter une ann√©e pr√©c√©dente';
            document.getElementById('historicalYearForm').reset();
            document.getElementById('deleteHistoricalYear').style.display = 'none';
            document.getElementById('historicalYearModal').classList.add('active');
        });

        document.getElementById('historicalYearForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const year = parseInt(document.getElementById('historicalYear').value);
            const ca = parseFloat(document.getElementById('historicalCA').value);
            const note = document.getElementById('historicalNote').value;
            
            // Check if year already exists
            const existingIndex = historicalYears.findIndex(hy => hy.year === year && hy.id !== editingHistoricalYearId);
            if (existingIndex !== -1) {
                alert('‚ùå Cette ann√©e existe d√©j√† dans l\'historique. Modifiez l\'entr√©e existante ou supprimez-la avant d\'en cr√©er une nouvelle.');
                return;
            }
            
            const yearData = {
                id: editingHistoricalYearId || Date.now(),
                year: year,
                ca: ca,
                note: note
            };
            
            if (editingHistoricalYearId) {
                const index = historicalYears.findIndex(hy => hy.id === editingHistoricalYearId);
                historicalYears[index] = yearData;
            } else {
                historicalYears.push(yearData);
            }
            
            saveData();
            document.getElementById('historicalYearModal').classList.remove('active');
            renderEvolution();
        });

        document.getElementById('cancelHistoricalYear').addEventListener('click', () => {
            document.getElementById('historicalYearModal').classList.remove('active');
        });

        document.getElementById('deleteHistoricalYear').addEventListener('click', () => {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette ann√©e historique ?')) {
                historicalYears = historicalYears.filter(hy => hy.id !== editingHistoricalYearId);
                saveData();
                document.getElementById('historicalYearModal').classList.remove('active');
                renderEvolution();
            }
        });

        function editHistoricalYear(id) {
            const hy = historicalYears.find(y => y.id === id);
            if (!hy) return;
            
            editingHistoricalYearId = id;
            document.getElementById('historicalYearModalTitle').textContent = 'Modifier l\'ann√©e';
            document.getElementById('historicalYear').value = hy.year;
            document.getElementById('historicalCA').value = hy.ca;
            document.getElementById('historicalNote').value = hy.note || '';
            document.getElementById('deleteHistoricalYear').style.display = 'block';
            document.getElementById('historicalYearModal').classList.add('active');
        }

        function deleteHistoricalYear(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette ann√©e historique ?')) {
                historicalYears = historicalYears.filter(hy => hy.id !== id);
                saveData();
                renderEvolution();
            }
        }

        // URSSAF Declaration
        function renderUrssafDeclaration() {
            document.getElementById('urssafYearDisplay').textContent = urssafYear;
            const container = document.getElementById('urssafQuarters');
            container.innerHTML = '';
            
            const quarters = [
                { name: 'T1', label: '1er Trimestre', months: [0, 1, 2], period: 'Janvier - Mars', deadline: 'Avant le 30 avril' },
                { name: 'T2', label: '2√®me Trimestre', months: [3, 4, 5], period: 'Avril - Juin', deadline: 'Avant le 31 juillet' },
                { name: 'T3', label: '3√®me Trimestre', months: [6, 7, 8], period: 'Juillet - Septembre', deadline: 'Avant le 31 octobre' },
                { name: 'T4', label: '4√®me Trimestre', months: [9, 10, 11], period: 'Octobre - D√©cembre', deadline: 'Avant le 31 janvier' }
            ];
            
            quarters.forEach(quarter => {
                const quarterCard = createQuarterCard(quarter);
                container.appendChild(quarterCard);
            });
        }

        function createQuarterCard(quarter) {
            const card = document.createElement('div');
            card.className = 'quarter-card';
            
            // Filter events for this quarter
            const quarterEvents = events.filter(e => {
                const eventDate = new Date(e.date);
                return eventDate.getFullYear() === urssafYear && 
                       quarter.months.includes(eventDate.getMonth());
            });
            
            const quarterCA = quarterEvents.reduce((sum, e) => sum + e.price, 0);
            const quarterUrssaf = quarterCA * 0.256;
            
            // Group events by service type for summary
            const serviceStats = {};
            quarterEvents.forEach(event => {
                const service = serviceTypes.find(s => s.id === event.serviceTypeId);
                if (service) {
                    if (!serviceStats[service.name]) {
                        serviceStats[service.name] = { count: 0, total: 0 };
                    }
                    serviceStats[service.name].count++;
                    serviceStats[service.name].total += event.price;
                }
            });
            
            card.innerHTML = `
                <div class="quarter-header">
                    <div>
                        <div class="quarter-title">${quarter.label} ${urssafYear}</div>
                        <div class="quarter-period">${quarter.period}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="color: var(--text-light); font-size: 0.85rem; margin-bottom: 0.3rem;">üìÖ √âch√©ance d√©claration</div>
                        <div style="font-weight: 600; color: var(--warning);">${quarter.deadline}</div>
                    </div>
                </div>
                
                <div class="quarter-stats">
                    <div class="quarter-stat">
                        <div class="quarter-stat-label">Chiffre d'Affaires</div>
                        <div class="quarter-stat-value">${quarterCA.toFixed(2)} ‚Ç¨</div>
                    </div>
                    <div class="quarter-stat">
                        <div class="quarter-stat-label">Cotisations URSSAF (25,6%)</div>
                        <div class="quarter-stat-value urssaf">${quarterUrssaf.toFixed(2)} ‚Ç¨</div>
                    </div>
                    <div class="quarter-stat">
                        <div class="quarter-stat-label">Nombre de prestations</div>
                        <div class="quarter-stat-value">${quarterEvents.length}</div>
                    </div>
                </div>
                
                ${quarterEvents.length > 0 ? `
                    <div class="prestations-list">
                        <div class="prestations-summary"><strong>D√©tail des prestations :</strong></div>
                        ${Object.entries(serviceStats).map(([name, stats]) => `
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border);">
                                <span>${name} (${stats.count}x)</span>
                                <span style="font-weight: 600; color: var(--primary);">${stats.total.toFixed(2)} ‚Ç¨</span>
                            </div>
                        `).join('')}
                    </div>
                ` : '<div style="color: var(--text-light); text-align: center; padding: 2rem; font-style: italic;">Aucune prestation ce trimestre</div>'}
                
                <div class="declaration-info">
                    <div>
                        <strong>üí° Montant √† d√©clarer sur autoentrepreneur.urssaf.fr</strong>
                        <div style="opacity: 0.9; font-size: 0.9rem; margin-top: 0.3rem;">L'URSSAF calculera automatiquement les cotisations</div>
                    </div>
                    <div style="font-size: 2rem; font-weight: 700; font-family: 'Playfair Display', serif;">
                        ${quarterCA.toFixed(2)} ‚Ç¨
                    </div>
                </div>
            `;
            
            return card;
        }

        document.getElementById('urssafPrevYear').addEventListener('click', () => {
            urssafYear--;
            renderUrssafDeclaration();
        });

        document.getElementById('urssafNextYear').addEventListener('click', () => {
            urssafYear++;
            renderUrssafDeclaration();
        });

        // Dashboard
        document.getElementById('dashboardPrevYear').addEventListener('click', () => {
            dashboardYear--;
            updateDashboard();
        });

        document.getElementById('dashboardNextYear').addEventListener('click', () => {
            dashboardYear++;
            updateDashboard();
        });

        function updateDashboard() {
            document.getElementById('dashboardYearDisplay').textContent = dashboardYear;
            
            const yearEvents = events.filter(e => {
                const eventYear = new Date(e.date).getFullYear();
                return eventYear === dashboardYear;
            });
            
            const totalRevenue = yearEvents.reduce((sum, e) => sum + e.price, 0);
            const urssafCharges = totalRevenue * 0.256; // 25.6% for BNC
            
            // Calculate other charges for the year
            const yearCharges = charges.filter(c => c.year === dashboardYear);
            const otherCharges = yearCharges.reduce((sum, c) => {
                if (c.frequency === 'annual') {
                    return sum + c.amount;
                } else {
                    // Monthly charge - count it once
                    return sum + c.amount;
                }
            }, 0);
            
            const totalChargesAmount = urssafCharges + otherCharges;
            const netIncome = totalRevenue - totalChargesAmount;
            
            document.getElementById('totalRevenue').textContent = `${totalRevenue.toFixed(2)} ‚Ç¨`;
            document.getElementById('totalUrssaf').textContent = `${urssafCharges.toFixed(2)} ‚Ç¨`;
            document.getElementById('totalCharges').textContent = `${otherCharges.toFixed(2)} ‚Ç¨`;
            document.getElementById('netIncome').textContent = `${netIncome.toFixed(2)} ‚Ç¨`;
            
            renderMonthlyBreakdown(yearEvents);
            renderServiceBreakdown(yearEvents);
            renderRevenueChart(yearEvents);
        }

        function renderMonthlyBreakdown(yearEvents) {
            const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
            const selector = document.getElementById('monthSelector');
            const breakdown = document.getElementById('revenueBreakdown');
            
            selector.innerHTML = '';
            monthNames.forEach((month, index) => {
                const btn = document.createElement('button');
                btn.className = 'month-btn';
                btn.textContent = month;
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.month-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    showMonthDetails(index, yearEvents);
                });
                selector.appendChild(btn);
            });
            
            // Auto-select current month or first month with data
            const currentMonthBtn = selector.children[new Date().getMonth()];
            if (currentMonthBtn) {
                currentMonthBtn.click();
            }
        }

        function showMonthDetails(monthIndex, yearEvents) {
            const breakdown = document.getElementById('revenueBreakdown');
            const monthEvents = yearEvents.filter(e => {
                const eventDate = new Date(e.date);
                return eventDate.getMonth() === monthIndex;
            });
            
            const monthRevenue = monthEvents.reduce((sum, e) => sum + e.price, 0);
            const monthUrssaf = monthRevenue * 0.256; // 25.6% for BNC
            
            // Calculate monthly charges
            const monthCharges = charges.filter(c => {
                if (c.year !== dashboardYear) return false;
                if (c.frequency === 'monthly' && c.month === monthIndex) return true;
                return false;
            });
            const monthOtherCharges = monthCharges.reduce((sum, c) => sum + c.amount, 0);
            
            const monthTotalCharges = monthUrssaf + monthOtherCharges;
            const monthNet = monthRevenue - monthTotalCharges;
            
            breakdown.innerHTML = `
                <div class="breakdown-item">
                    <span class="breakdown-label">Chiffre d'affaires</span>
                    <span class="breakdown-value">${monthRevenue.toFixed(2)} ‚Ç¨</span>
                </div>
                <div class="breakdown-item">
                    <span class="breakdown-label">Cotisations URSSAF (25,6%)</span>
                    <span class="breakdown-value negative">-${monthUrssaf.toFixed(2)} ‚Ç¨</span>
                </div>
                <div class="breakdown-item">
                    <span class="breakdown-label">Autres charges</span>
                    <span class="breakdown-value negative">-${monthOtherCharges.toFixed(2)} ‚Ç¨</span>
                </div>
                <div class="breakdown-item" style="border-top: 2px solid var(--border); margin-top: 0.5rem; padding-top: 1rem;">
                    <span class="breakdown-label"><strong>Revenu net</strong></span>
                    <span class="breakdown-value positive">${monthNet.toFixed(2)} ‚Ç¨</span>
                </div>
                <div class="breakdown-item">
                    <span class="breakdown-label">Nombre de prestations</span>
                    <span class="breakdown-value">${monthEvents.length}</span>
                </div>
            `;
        }

        function renderServiceBreakdown(yearEvents) {
            const breakdown = document.getElementById('serviceBreakdown');
            breakdown.innerHTML = '';
            
            const serviceStats = {};
            
            yearEvents.forEach(event => {
                const service = serviceTypes.find(s => s.id === event.serviceTypeId);
                if (!service) return;
                
                if (!serviceStats[service.id]) {
                    serviceStats[service.id] = {
                        name: service.name,
                        color: service.color,
                        count: 0,
                        revenue: 0
                    };
                }
                
                serviceStats[service.id].count++;
                serviceStats[service.id].revenue += event.price;
            });
            
            Object.values(serviceStats).forEach(stat => {
                const item = document.createElement('div');
                item.className = 'breakdown-item';
                item.style.borderLeft = `4px solid ${stat.color}`;
                item.innerHTML = `
                    <div>
                        <div class="breakdown-label">${stat.name}</div>
                        <div style="color: var(--text-light); font-size: 0.9rem;">${stat.count} prestation(s)</div>
                    </div>
                    <span class="breakdown-value">${stat.revenue.toFixed(2)} ‚Ç¨</span>
                `;
                breakdown.appendChild(item);
            });
        }

        function renderRevenueChart(yearEvents) {
            const canvas = document.getElementById('revenueChart');
            const legendContainer = document.getElementById('chartLegend');
            
            if (!canvas) return;
            
            // Destroy existing chart
            if (revenueChart) {
                revenueChart.destroy();
            }
            
            // Calculate stats by service type
            const serviceStats = {};
            let totalRevenue = 0;
            
            yearEvents.forEach(event => {
                const service = serviceTypes.find(s => s.id === event.serviceTypeId);
                if (!service) return;
                
                if (!serviceStats[service.id]) {
                    serviceStats[service.id] = {
                        name: service.name,
                        color: service.color,
                        count: 0,
                        revenue: 0
                    };
                }
                
                serviceStats[service.id].count++;
                serviceStats[service.id].revenue += event.price;
                totalRevenue += event.price;
            });
            
            // Prepare chart data
            const labels = [];
            const data = [];
            const colors = [];
            const percentages = [];
            
            Object.values(serviceStats).forEach(stat => {
                labels.push(stat.name);
                data.push(stat.revenue);
                colors.push(stat.color);
                percentages.push(totalRevenue > 0 ? (stat.revenue / totalRevenue * 100).toFixed(1) : 0);
            });
            
            // Create chart
            const ctx = canvas.getContext('2d');
            revenueChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Chiffre d\'Affaires (‚Ç¨)',
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors.map(c => c),
                        borderWidth: 2,
                        borderRadius: 8,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const value = context.parsed.y;
                                    const percentage = percentages[index];
                                    return [
                                        `CA: ${value.toFixed(2)} ‚Ç¨`,
                                        `Part: ${percentage}%`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('fr-FR') + ' ‚Ç¨';
                                },
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 13,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
            
            // Render custom legend with percentages
            legendContainer.innerHTML = '';
            Object.values(serviceStats).forEach((stat, index) => {
                const percentage = percentages[index];
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.innerHTML = `
                    <div class="legend-color" style="background-color: ${stat.color};"></div>
                    <div>
                        <div class="legend-text">${stat.name}</div>
                        <div class="legend-value">${stat.revenue.toFixed(2)} ‚Ç¨ (${percentage}%)</div>
                    </div>
                `;
                legendContainer.appendChild(legendItem);
            });
        }

        // Initialisation
        // Save initial data if not already present
        if (!localStorage.getItem('serviceTypes')) {
            saveData();
        }
        renderCalendar();
        renderServiceTypes();
        checkBackupReminder();
    </script>
</body>
</html>